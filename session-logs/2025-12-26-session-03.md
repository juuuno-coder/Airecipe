# Session Log: 2025-12-26 01:00

**Topic:** 관리자 기능(댓글/설정)구현, 유저 동기화 문제 해결 및 성능 최적화 대수술

## 📊 요약 (Summary)

- [x] **관리자 댓글 관리 (`/admin/comments`) 구현**: 댓글 목록 조회 및 삭제 기능 추가.
- [x] **사이트 설정 (`/admin/settings`) 구현**: 전역 공지사항 배너 및 점검 모드 제어 기능 추가.
- [x] **빌드 및 배포 에러 수정**: `use-debounce` 제거, UI 컴포넌트(`Select`) 교체, 타입 에러 해결.
- [x] **관리자 유저 목록 누락 해결**: `auth.users` <-> `profiles` 동기화 로직 개선 (`created_at` 컬럼 추가).
- [x] **웹사이트 성능 최적화 (Speed-Up)**: `RootLayout`의 DB 조회 제거(정적화), 과도한 UI 효과 제거, ISR 캐싱 시간 증대(3600s).
- [x] **레시피 관리 고도화**: 정렬(조회수/좋아요), 카테고리 필터링, UI 개선.
- [x] **Vercel 빌드 수정**: `CommentsSection` import 방식 수정 (Named -> Default).
- [x] **DB & Storage 권한 설정**: 상세 페이지 404 및 이미지 업로드 오류 해결을 위한 SQL 스크립트 작성 (사용자 수동 실행).

## 📝 상세 대화 및 작업 로그

### 1. 관리자 기능 확장 (댓글 & 설정)

> **사용자:** 관리자 패널의 기능을 완성하고 싶음 (댓글 관리, 사이트 설정).
> **AI:**
>
> - `src/app/admin/comments/`: 댓글 목록 조회 및 삭제 로직 구현.
> - `src/app/admin/settings/`: 전역 공지사항(Announcement) 및 점검 모드(Maintenance) 스위치 구현.
> - `setup_site_settings.sql`을 통해 설정 테이블 생성.

### 2. 빌드 에러 및 이슈 대응

> **사용자:** 배포 시 빌드 에러 발생 (`npm run build` 실패).
> **AI:**
>
> - 원인: `use-debounce` 모듈 누락 및 `shadcn` 컴포넌트 미설치.
> - 조치: `Select` 컴포넌트를 네이티브 HTML 태그로 교체하여 의존성 제거.
> - `SiteHeader`가 중복되는 문제 해결 (Admin 페이지에서는 헤더 숨김 처리).

### 3. 유저 목록 조회 불가 문제 (Deep Debugging)

> **사용자:** `/admin/users`에 유저가 보이지 않음 ("No rows returned").
> **AI:**
>
> - **시도 1 (권한):** RLS 정책이 관리자 조회를 막는지 의심 -> `fix_permissions.sql` 실행. (실패)
> - **시도 2 (동기화):** `auth.users`에는 있지만 `public.profiles` 테이블에 데이터가 복사되지 않았음 발견. -> `fix_missing_users.sql` (동기화 트리거 생성).
> - **시도 3 (스키마):** `profiles` 테이블에 `created_at` 컬럼이 없어서 동기화 쿼리 실패 -> `sync_users_final.sql`로 컬럼 추가 및 강제 동기화 수행. -> **해결 완료 (3명 조회됨).**

### 4. 성능 최적화 및 레이아웃 경량화

> **사용자:** 사이트가 느리고 디자인이 과함. 속도 개선 요구.
> **AI:**
>
> - **원인 분석:** `RootLayout`에서 매번 DB 호출(설정 확인 등)을 하여 서버 응답 대기 시간이 발생(TTFB 증가). 과도한 Blur/Noise 효과가 브라우저 렌더링 부하 유발.
> - **조치:**
>   - `layout.tsx`를 완전 정적(Static)으로 전환 (DB 조회 로직 제거).
>   - `RecipePage`: 복잡한 그리드 레이아웃을 '읽기 전용'의 단순한 1단 컬럼으로 변경. 이미지 로딩 최적화.
>   - `HomePage`: 히어로 섹션의 무거운 배경 애니메이션 제거, 캐싱(`revalidate`) 시간을 3600초로 대폭 상향.

### 5. 레시피 관리 기능 고도화

> **사용자:** 레시피 관리 목록 기능 강화 요청.
> **AI:**
>
> - `CategoryFilter`: 카테고리별 필터링 기능 추가.
> - `SortSelect`: 최신순, 조회수순, 좋아요순 정렬 기능 추가.
> - 테이블 UI 개선 (썸네일, 배지, 작성자 정보 강화).

### 6. 저장소(Storage) 및 빌드 오류 수정

> **사용자:** 이미지 업로드 시 "Bucket not found" 에러 발생.
> **AI:** `setup_storage.sql` 스크립트를 작성하여 `recipe-images` 버킷 생성 및 RLS 정책(공개 읽기, 인증 업로드) 재설정.
> **사용자:** Vercel 빌드 에러 (`CommentsSection` export 없음).
> **AI:** `RecipePage`에서 `CommentsSection`을 Named Import(`{}`)에서 Default Import로 변경하여 해결.

### 7. 상세 페이지 404 해결 (DB 권한)

> **사용자:** 레시피 등록했는데 상세 페이지가 안 보임 (404/Not Found). but 랭킹엔 뜸.
> **AI:**
>
> - RLS(Row Level Security) 문제로 판단. `select` 권한이 닫혀있음.
> - `fix_rls_public_view.sql` 생성 및 제공.
> - 사용자 SQL 직접 실행 -> **해결됨**.

## 💡 인사이트 (Insights)

- **Zero-Blocking Layout:** Next.js의 `layout.tsx`는 가급적 서버 데이터를 기다리지 않게(비동기 호출 없이) 작성해야 전체 사이트 속도가 보장된다. 공통 데이터는 클라이언트 컴포넌트에서 비동기로 가져오거나 정적으로 구워서 해결하는 것이 좋다.
- **Sync is Vital:** Supabase 사용 시 `auth` 스키마와 `public` 스키마 간의 데이터 동기화는 서비스 초기에 확실히 잡아두지 않으면 '유령 유저' 문제로 이어진다.
- **Admin UX:** 데이터가 쌓일수록 '검색'만으로는 부족하다. '필터'와 '정렬'은 관리자 도구의 필수 요소다.
